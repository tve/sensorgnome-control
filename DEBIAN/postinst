#! /bin/bash -e
echo "Running sg-control postinst in $(pwd)"
SG=/opt/sensorgnome # would be nice to derive that from some env var...

# install acquisition.txt and tag database if not there
SRC=$SG/templates
for f in acquisition.txt SG_tag_database.sqlite; do
    if [[ -d /data/config ]]; then
        # $SRC/$f exists, so this must be an update, put it there unless it exists
        [[ -f /data/config/$f ]] || cp $SRC/$f /data/config
    else
        # $SRC/$f does not exist, so this must be a fresh install, put it into /boot
        # it will be copied to $SRC on first boot
        [[ -f /boot/$f ]] || cp $SRC/$f /boot
    fi
done

# enable and start/restart units
for U in sg-control; do
    # code from debhelper's postinst-systemd-enable template
    if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
        # This will only remove masks created by d-s-h on package removal.
        deb-systemd-helper unmask $U >/dev/null || true

        # was-enabled defaults to true, so new installations run enable.
        if deb-systemd-helper --quiet was-enabled $U; then
            # Enables the unit on first installation, creates new
            # symlinks on upgrades if the unit file has changed.
            deb-systemd-helper enable $U.service || true
        else
            # Update the statefile to add new symlinks (if any), which need to be
            # cleaned up on purge. Also remove old symlinks.
            deb-systemd-helper update-state $U >/dev/null || true
        fi
    fi

    # Restart service, if it is running
    systemctl daemon-reload
    if systemctl is-active --quiet $U.service; then
        echo "Restarting $U.service"
        systemctl restart $U.service
    fi
done
